# Experimental!
# Vampire Survivors like game

~ "lib.ua"
  ~ ECS
  ~ M!

I ~ "git: https://github.com/marcos-cat/iris"

I~Open 500_600 "Uiua Survivors"
Â°I~Screen~FPS 60

Compâ€¼ â†^ (
  .Â°â–¡â‚‚
  $$ ECS~NewC "_"
  $$ ~_ [_]
)
BCompâ€¼ â†^ (
  .Â°â–¡â‚‚
  $$ ECS~NewC "_"
  $$ ~_ {_}
)

# TODO: make components use struct of arrays instead of array of structs

ECS
Compâ€¼(Position|x y)
Compâ€¼(Velocity|x y)
Compâ€¼(Health|Current Regen Max)
BCompâ€¼(Sprite|Texture Size)
Compâ€¼(Path|Path)
â”Œâ”€â•´Paths
  |Point [x y]
  |Player
  |Enemy [i]
â””â”€â•´
Compâ€¼(Defense|Magical Physical)
Compâ€¼(Offense|NYI)
BCompâ€¼(Collision|Solid Size Offset)
BCompâ€¼(Inventory|Weapons Items)
Compâ€¼(Weapon|Weapon)
Compâ€¼(Item|Item)
Compâ€¼(Pickup|Pickup)
Compâ€¼(PlayerTag|Î©)
Compâ€¼(EnemyTag|Î©)
Compâ€¼(ProjectileTag|Î©)

# TODO: sprite sheet logic
# TODO: animations -> offset into texture
â”Œâ”€â•´Sprite
  ~ {Texture Size}

  # sprite ? file
  Load â† New âŠƒ(I~Texture~LoadFile|â–³â‚‚â—ŒÂ°img&frab)

  Player â† New I~Texture~LoadImage â†¯âŠ™Greenâ¤šâŠ‚âŠ™3 16_16

  Enemy â† New I~Texture~LoadImage â†¯âŠ™Redâ¤šâŠ‚âŠ™3 16_16

â””â”€â•´

# ecs ? ecs
Movement â† ECS!(
  SetDâŠ“/â—‡+âŠ™"Position"âŠ¸â¤šGetDâ—¡Filter{"Position" "Velocity"}
)

Repulsion â† ECS!(
  Ï â† 0.2 # repulsion strength
  CPos â† +âŠ“Ã·â‚‚â—‡+â—‡Collision!âŠƒSize OffsetâŠƒâŠâ‚€âŠâ‚‚
  Rect â† âŠ™â—‡+â—‡Collision!âŠƒSize OffsetâŠƒâŠâ‚€âŠâ‚‚
  Apply â† (
    âŠƒ(âˆ©âŠâ‚|Ã—ÏÃ·âŠ¸âœÂ°âˆš/+â—‡-âˆ©CPos|âˆ©â—‡âˆ˜âˆ©âŠ£)
    SetD âŠ™âŠ™"Velocity" âˆ©âŠŸ â—‡âŠ“âŒŸ-+
  )

  âŠ¸â¤šGetDâ—¡Filter{"Collision" "Velocity" "Position"}
  âŠ›â—‡âœÃ·â‚…â‚€âŒŠ âŠƒâŠâ‚‚â‰ â–½â‰¡â—‡Collision~SolidâŠ¸âŠ¢ âŠ‚â‰¡â—‡â‰¡â–¡
  /â—‡âŠ‚âŠ•(â–¡â–½âŠ¸â‰¡/(âŠƒ(âˆ©(I~Draw~Rect Blue))I~Collide~Rectsâˆ©Rect) â§…â‚‚<)
  âˆ§Apply Â°âŠŸâ¤¸â‚
)

Render â†š â‰¡â—‡(I~Texture~DrawÂ°Sprite) Â°â–¡â‚‚

# ecs ? ecs
Rendering â† ECS!(
  RenderâŠ¸GetDâ—¡Filter{"Sprite" "Position"}
)

# TODO: random enemies types
Spawning â† ECS!(
  â¨¬â—Œ(âŠ™âŠ¸(Â°â–¡â‚ GetDâŠ™"Position"âŠ¸Filter"PlayerTag")
     âœâ‰+ Ã—400 -0.5 genâŠ™âš‚âŠ‚âŠ™2
     âˆ§â—‡NewEâšM!(
      Position â†’ âˆ˜
    | Path â†’ Paths~Player
    | Health â†’ 1e3_Â¯1_1e4
    | Velocity â†’ -1/2âš‚_âš‚
    | Collision â†’ {1 16_16 0_0}
    | Sprite â†’ Sprite~Enemy
    | EnemyTag â†’ âˆ
    )
  )âŠƒ>â‚€â†§â‚â‚€-âŠ™100â§»âŠ¸Filter"EnemyTag"
)

Dying â† ECS!(
  âˆ§RemoveEâ–½â‰¤â‚€â‰¡Health~CurrentâŠ¸â¤šGetDâ—¡Filter"Health"
)

Regeneration â† ECS!(
  â—¡GetDâ—¡Filter"Health"
  SetDâ‰¡â—‡Health!(âœâŠƒCurrent MaxâŠ¸â†§ âœâŠƒCurrent RegenâŠ¸+)
  # â—¡Filter"Health"
  # âœData â‰¡â—‡Health!(âœâŠƒCurrent MaxâŠ¸â†§ âœâŠƒCurrent RegenâŠ¸+)
)

Paths â† ECS!(
  âŠ¸âŠƒ(â¤šGetDâ—¡Filter{"Path" "Position" "Velocity"}|GetDâŠ™"Position"âŠ¸Filter"PlayerTag")
  â‰¡Â°âŠ‚Â°â–¡â‚ƒ
  # â¨¬( # to point
  # | â‹…ğ„âŒŸ-
  # )
)

Controls â† ECS!(
  âŠ¸âŠ“(Filter{"PlayerTag"}|"Velocity")
  SetD Â¤Ã—â‚…â¨¬â—ŒÃ·âŠ¸â‰ â‚€âŠ¸âœÂ°âˆš/+ âŠŸÂ°â„‚ /+ I~Key~WASD 0
)

ECS!(
  NewE M!(
    Position â†’ 200_200
  | Velocity â†’ 0_0
  | Health â†’ 100_5_100
  | Collision â†’ {1 16_16 0_0}
  | Sprite â†’ Sprite~Player
  | PlayerTag â†’ âˆ
  )

  # I~Loop!(
  #   I~Draw~Background Black
  #   Spawning
  #   Repulsion
  #   Dying
  #   Regeneration
  #   Controls
  #   Movement
  #   Rendering
  # )

  Spawning
  Paths
)
