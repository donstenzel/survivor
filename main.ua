# Experimental!
# Vampire Survivors like game

~ "lib.ua"
  ~ ECS
  ~ M!

I ~ "git: https://github.com/marcos-cat/iris"

I~Open 500_600 "Uiua Survivors"
Â°I~Screen~FPS 60

Compâ€¼ â†^ (
  .Â°â–¡â‚‚
  $$ ECS~NewC "_"
  $$ ~_ [_]
)
BCompâ€¼ â†^ (
  .Â°â–¡â‚‚
  $$ ECS~NewC "_"
  $$ ~_ {_}
)

Norm â† â¨¬Ã·â—ŒâŠ¸=â‚€âŠ¸âœÂ°âˆš/+

# TODO: make components use struct of arrays instead of array of structs

ECS
Compâ€¼(Position|x y)
Compâ€¼(Velocity|x y)
Compâ€¼(Health|Current Regen Max)
BCompâ€¼(Sprite|Texture Size)
Compâ€¼(Path|Path)
â”Œâ”€â•´Paths
  |Point [x y]
  |Player []
  |Enemy [i]
â””â”€â•´
Compâ€¼(Defense|Magical Physical)
Compâ€¼(Offense|NYI)
BCompâ€¼(Collision|Solid Size Offset)
BCompâ€¼(Inventory|Weapons Items)
Compâ€¼(Weapon|Weapon)
Compâ€¼(Item|Item)
Compâ€¼(Pickup|Pickup)
Compâ€¼(PlayerTag|Î©)
Compâ€¼(EnemyTag|Î©)
Compâ€¼(ProjectileTag|Î©)

# TODO: sprite sheet logic
# TODO: animations -> offset into texture
â”Œâ”€â•´Sprite
  ~ {Texture Size}

  # sprite ? file
  Load â† New âŠƒ(I~Texture~LoadFile|â–³â‚‚â—ŒÂ°img&frab)

  Player â† New I~Texture~LoadImage â†¯âŠ™Greenâ¤šâŠ‚âŠ™3 16_16

  Enemy â† New I~Texture~LoadImage â†¯âŠ™Redâ¤šâŠ‚âŠ™3 16_16

â””â”€â•´

# ecs ? ecs
Movement â† ECS!(
  SetDâŠ“/â—‡+âŠ™"Position"âŠ¸â¤šGetDâ—¡Filter{"Position" "Velocity"}
)

Render â†š â‰¡â—‡(I~Texture~DrawÂ°Sprite) Â°â–¡â‚‚

# ecs ? ecs
Rendering â† ECS!(
  RenderâŠ¸GetDâ—¡Filter{"Sprite" "Position"}
)

# TODO: random enemies types
Spawning â† ECS!(
  â¨¬â—Œ(âŠ™âŠ¸(Â°â–¡â‚ GetDâŠ™"Position"âŠ¸Filter"PlayerTag")
     âœâ‰+ Ã—400 -0.5 genâŠ™âš‚âŠ‚âŠ™2
     âˆ§â—‡NewEâšM!(
      Position â†’ âˆ˜
    | Path â†’ Paths~Player
    | Health â†’ 1e3_Â¯1_1e4
    | Velocity â†’ -1/2âš‚_âš‚
    | Collision â†’ {1 16_16 0_0}
    | Sprite â†’ Sprite~Enemy
    | EnemyTag â†’ âˆ
    )
  )âŠƒ>â‚€â†§â‚â‚€-âŠ™100â§»âŠ¸Filter"EnemyTag"
)

Dying â† ECS!(
  âˆ§RemoveEâ–½â‰¤â‚€â‰¡Health~CurrentâŠ¸â¤šGetDâ—¡Filter"Health"
)

Regeneration â† ECS!(
  â—¡GetDâ—¡Filter"Health"
  SetDâ‰¡â—‡Health!(âœâŠƒCurrent MaxâŠ¸â†§ âœâŠƒCurrent RegenâŠ¸+)
  # â—¡Filter"Health"
  # âœData â‰¡â—‡Health!(âœâŠƒCurrent MaxâŠ¸â†§ âœâŠƒCurrent RegenâŠ¸+)
)

Repulsion â† ECS!(
  Ï â† 0.2 # repulsion strength
  CPos â† +âŠ“Ã·â‚‚â—‡+â—‡Collision!âŠƒSize OffsetâŠƒâŠâ‚€âŠâ‚‚
  Rect â† âŠ™â—‡+â—‡Collision!âŠƒSize OffsetâŠƒâŠâ‚€âŠâ‚‚
  Apply â† (
    âŠƒ(âˆ©âŠâ‚|Ã—Ï Normâ—‡-âˆ©CPos|âˆ©â—‡âˆ˜âˆ©âŠ£)
    SetD âŠ™âŠ™"Velocity" âˆ©âŠŸ â—‡âŠ“âŒŸ-+
  )

  âŠ¸â¤šGetDâ—¡Filter{"Collision" "Velocity" "Position"}
  âŠ›â—‡âœÃ·â‚…â‚€âŒŠ âŠƒâŠâ‚‚â‰ â–½â‰¡â—‡Collision~SolidâŠ¸âŠ¢ âŠ‚â‰¡â—‡â‰¡â–¡
  /â—‡âŠ‚âŠ•(â–¡â–½âŠ¸â‰¡/(âŠƒ(âˆ©(I~Draw~Rect Blue))I~Collide~Rectsâˆ©Rect) â§…â‚‚<)
  âˆ§Apply Â°âŠŸâ¤¸â‚
)

Tracking â† ECS!(
  Î¾ â† 4e`2 # tracking tendency
  â‰¡Â°âŠ‚âŠ“Â°â–¡â‚ƒ:âŠ¸âŠƒ(
    â¤šGetDâ—¡Filter{"Path" "Position" "Velocity"}
  | GetDâŠ™"Position"âŠ¸Filter"PlayerTag"
  )
  + Ã—Î¾ â¨¬(
    Norm âŠ“Ëœ-âˆ˜ # To point â†’ norm(Pos - Point)
  | Normâ‹…ğ„âŒŸ-  # To player â†’ norm(PlayerPos - Pos)
    # | # To enemy â†’ norm(GetD(i, "Position") - Pos)
  )
  SetD âŠ™âŠ™"Velocity"
)

Cohesion â† ECS!(
  Ï‡ â† 2e`3 # cohesion scale
  âŠ¸â¤šGetDâŠ™{"Position" "Velocity"}âŠ¸Filter"EnemyTag"
  âˆ©/â—‡âŠ‚ âŠ•(âˆ©â–¡ +Ã—Ï‡â‰¡Norm -âŸœ[Ã·âŠƒâ§»/+])âŠ›âŠ¸âœÃ·â‚‚â‚€â‚€âŒŠ Â°â–¡â‚‚
  SetDâŠ™âŠ™"Velocity"
)

Alignment â† ECS!(
  Î± â† 3e`3 # alignment tendency
  âŠ¸â¤šGetDâŠ™{"Position" "Velocity"}âŠ¸Filter"EnemyTag"
  âˆ©/â—‡âŠ‚ âŠ•(âˆ©â–¡ +âŒÃ—Î± Norm Ã·âŠ¸âŠƒâ§»/+)âŠ›âœÃ·â‚‚â‚€â‚€âŒŠ Â°â–¡â‚‚
  SetDâŠ™âŠ™"Velocity"
)

Controls â† ECS!(
  âŠ¸âŠ“(Filter"PlayerTag"|"Velocity")
  SetD Â¤Ã—â‚…â¨¬â—ŒÃ·âŠ¸â‰ â‚€âŠ¸âœÂ°âˆš/+ âŠŸÂ°â„‚ /+ I~Key~WASD 0
)

# Sanity checking
# ensures some invariants, like the maximum possible velocity etc.
Sanity â† ECS!(
  SetDâœÂ°Ã—âŠ™â†§â‚â—¡GetDâ—¡Filter"Velocity"
)

ECS!(
  NewE M!(
    Position â†’ 200_200
  | Velocity â†’ 0_0
  | Health â†’ 100_5_100
  | Collision â†’ {1 16_16 0_0}
  | Sprite â†’ Sprite~Player
  | PlayerTag â†’ âˆ
  )

  I~Loop!(
    I~Draw~Background Black
    Spawning
    Tracking
    Cohesion
    Alignment
    Repulsion
    Sanity
    Dying
    Regeneration
    Controls
    Movement
    Rendering
  )

  # â¥â‚â‚€Spawning
  # Cohesion
)
